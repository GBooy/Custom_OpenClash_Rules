name: Modify Custom_Clash.ini url-test To select

on:
  schedule:
    - cron: '0 22 * * *'   # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š6ç‚¹è‡ªåŠ¨åŒæ­¥ (UTC 22:00)
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-and-modify:
    runs-on: ubuntu-latest
    # å¿…é¡»èµ‹äºˆå†™å…¥æƒé™ï¼Œå¦åˆ™æ— æ³• push
    permissions:
      contents: write

    steps:
      # Step 1: æ£€å‡ºä½ è‡ªå·±(GBooy)çš„ä»“åº“
      - name: Checkout My Repo
        uses: actions/checkout@v3

      # Step 2: ä¸‹è½½ä¸Šæ¸¸æ–‡ä»¶å¹¶è¿›è¡Œé­”æ”¹
      - name: Download and Modify
        run: |
          # 1. ç¡®ä¿æœ¬åœ° cfg ç›®å½•å­˜åœ¨
          mkdir -p cfg

          # 2. ä»ä¸Šæ¸¸ (Aethersailor) ä¸‹è½½æœ€æ–°åŸå§‹æ–‡ä»¶åˆ°ä¸´æ—¶æ–‡ä»¶
          # ä½¿ç”¨ raw.githubusercontent.com è·å–çº¯æ–‡æœ¬
          echo "æ­£åœ¨ä¸‹è½½ä¸Šæ¸¸æ–‡ä»¶..."
          curl -sSL "https://raw.githubusercontent.com/Aethersailor/Custom_Clash_Rules/main/cfg/Custom_Clash.ini" -o raw_file.ini

          # 3. å¼€å§‹ä¿®æ”¹é€»è¾‘
          echo "å¼€å§‹å¤„ç†æ–‡ä»¶..."

          # [é€»è¾‘ A] åªä¿ç•™ [custom] åŠå…¶åå†…å®¹
          awk '/\[custom\]/{f=1} f' raw_file.ini > processed.ini

          # [é€»è¾‘ B] å‡†å¤‡å¤´éƒ¨æ³¨é‡Š
          cat > header.txt << 'EOF'
          ;Custom_Clash_Rules (Sync & Modified)
          ;å…¨åˆ†ç»„é˜² DNS æ³„æ¼è®¢é˜…è½¬æ¢æ¨¡æ¿
          ;æºé¡¹ç›®ï¼šhttps://github.com/Aethersailor/Custom_Clash_Rules
          ;å½“å‰ä»“åº“ï¼šhttps://github.com/GBooy/Custom_OpenClash_Rules
          ;åŸºäº ACL4SSR æ¨¡æ¿é­”æ”¹ï¼Œå·²æ›¿æ¢ url-test ä¸º select
          
          EOF

          # [é€»è¾‘ C] åˆå¹¶å¤´éƒ¨
          cat header.txt processed.ini > final_file.ini

          # [é€»è¾‘ D] åˆ é™¤ CN è§„åˆ™
          sed -i '/GEOSITE,cn/d' final_file.ini
          sed -i '/GEOIP,cn/d' final_file.ini

          # [é€»è¾‘ E] æ’å…¥å…¨çƒç›´è¿è§„åˆ™ (åœ¨ Custom_Proxy ä¸‹æ–¹)
          sed -i '/Custom_Proxy/a ruleset=ğŸ¯ å…¨çƒç›´è¿,[]GEOIP,cn,no-resolve' final_file.ini
          sed -i '/Custom_Proxy/a ruleset=ğŸ¯ å…¨çƒç›´è¿,[]GEOSITE,cn' final_file.ini

          # [é€»è¾‘ F] ğŸ”¥æ–°éœ€æ±‚ğŸ”¥ï¼šå°† url-test æ›¿æ¢ä¸º select
          # sä»£è¡¨æ›¿æ¢, gä»£è¡¨å…¨å±€(ä¸€è¡Œå†…æ‰€æœ‰åŒ¹é…é¡¹)
          sed -i 's/url-test/select/g' final_file.ini

          # 4. å°†å¤„ç†å¥½çš„æ–‡ä»¶ç§»åŠ¨åˆ°æœ€ç»ˆä½ç½®
          mv final_file.ini cfg/Custom_Clash.ini

          # 5. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f raw_file.ini processed.ini header.txt
          
          echo "ä¿®æ”¹å®Œæˆï¼Œé¢„è§ˆå‰15è¡Œï¼š"
          head -n 15 cfg/Custom_Clash.ini

      # Step 3: æäº¤å¹¶æ¨é€åˆ°ä½ çš„ä»“åº“
      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add cfg/Custom_Clash.ini
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–ï¼Œæœ‰å˜åŒ–æ‰æäº¤
          if ! git diff --cached --quiet; then
            git commit -m "Auto-sync: Upstream update + Modify url-test to select"
            
            # å› ä¸ºæ˜¯åœ¨ Checkout è‡ªå·±çš„ä»“åº“ï¼Œä¸”æœ‰ permissions: writeï¼Œ
            # è¿™é‡Œçš„ push ä¸éœ€è¦ Token URLï¼Œç›´æ¥ push å³å¯
            git push
            echo "âœ… æ¨é€æˆåŠŸï¼"
          else
            echo "âš ï¸ æ–‡ä»¶å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          fi
